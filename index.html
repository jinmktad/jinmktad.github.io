<script>
  // 최신 배포 URL (/exec)
  const EXEC_URL = "https://script.google.com/macros/s/AKfycbymPnv4TLs7Ntt20zWCcSn8lN6rzZwAWL21Ki0nVU50bq7vbjQ6EnrE8Ymdcc24-wdzLQ/exec";

  const form = document.getElementById('leadForm');
  const btn  = document.getElementById('submitBtn');

  function getUTM() {
    const p = new URLSearchParams(location.search);
    return {
      utm_source:   p.get('utm_source')   || '',
      utm_medium:   p.get('utm_medium')   || '',
      utm_campaign: p.get('utm_campaign') || '',
      utm_term:     p.get('utm_term')     || '',
      utm_content:  p.get('utm_content')  || '',
    };
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!form.reportValidity()) return;

    btn.disabled = true;
    btn.textContent = '전송 중…';

    // 1) form fields → URLSearchParams (x-www-form-urlencoded)
    const params = new URLSearchParams();
    for (const [k, v] of new FormData(form).entries()) params.append(k, v);

    // 2) add extra fields (no CORS preflight)
    const extras = {
      ...getUTM(),
      referrer:   document.referrer || '',
      user_agent: navigator.userAgent || '',
      page:       location.pathname + location.search
    };
    Object.entries(extras).forEach(([k, v]) => params.append(k, v));

    try {
      const res = await fetch(EXEC_URL, {
        method: 'POST',
        body: params                      // ★ 헤더 지정 금지 (브라우저가 자동 설정)
      });

      // Apps Script가 JSON을 주든 문자열을 주든 안전하게 처리
      let data = null;
      try { data = await res.json(); } catch(_) { data = null; }

      if ((data && data.ok) || res.ok) {
        location.href = '/thank-you.html';
      } else {
        alert('전송 실패: 잠시 후 다시 시도해주세요.');
        console.log('Response status:', res.status, 'body:', data);
        btn.disabled = false;
        btn.textContent = '상담 신청하기';
      }
    } catch (err) {
      alert('네트워크 오류: 잠시 후 다시 시도해주세요.');
      console.error(err);
      btn.disabled = false;
      btn.textContent = '상담 신청하기';
    }
  });
</script>
